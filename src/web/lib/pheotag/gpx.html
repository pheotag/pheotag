<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">

<dom-module id="geotag-gpx">

    <template>
        <style>
            :host {
                display: flex;
                flex-direction: column;
                width: 100%;
                height: 100%;
                font-size: 10pt;
                font-family: Roboto;
            }
            button {
                cursor: pointer;
            }
            .file {
                flex: initial;
                overflow-x: hidden;
                word-wrap: none;
                white-space: nowrap;
                padding: 0.25em;
                border-bottom: 1px solid lightgrey;
            }
            #file {
                outline: none; /* disable chromium highlighting of input fields */
                -webkit-appearance: none;
                   -moz-appearance: none;
                        appearance: none;
            }
            .clear {
                color: red;
            }
            .export {
                color: royalblue;
            }
            #filter {
                flex: initial;
                margin: 0.25em;
                width: calc(100% - 0.75em);
                outline: none; /* disable chromium highlighting of input fields */
            }
            #container {
                flex: 1;
                overflow-y: scroll;
            }
            .waypoint {
                margin: 10px;
                box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5);
            }
            .photo {
                color: whitesmoke;
                border: 1px solid black;
                background-color: black;
            }
            .time {
                padding: 0.15em;
                text-align: center;
            }
            .latlong {
                padding: 0.15em;
                text-align: center;
                font-family: monospace;
            }
            .control {
                flex: initial;
                display: table;
                width: calc(100% - 2*0.15em);
                padding: 0.15em;
            }
            .control > .left {
                display: table-cell;
                text-align: left;
            }
            .control > .right {
                display: table-cell;
                text-align: right;
            }
            .insertor {
                margin-top: 10px;
                text-align: center;
            }
        </style>
        <div class="file">
                <input id="file" type="file" on-change="_changedGeoFile" accept=".gpx,.kml" />
            <button class="clear" on-click="_clickClear" title="Clear the list of waypoints">&#10008;</button>
            <button class="export" on-click="_clickExport" title="Export the list of waypoints">&#129095;</button>
        </div>
        <input id="filter" type="text" value="{{ filter::input }}"/>
        <div id="container">
            <div class="insertor">
                <button on-click="_clickInsertWaypoint" title="Insert a new waypoint with the current location from the map at the beginning">&#10133;</button>
            </div>
            <template is="dom-repeat" items="[[ geo.waypoints ]]">
                <div class$="waypoint [[ _classForWaypoint(item) ]]" title$="[[ _tooltip(item) ]]">
                    <div class="time">[[ _date(item.time,item.timezone) ]]</div>
                    <div class="latlong">
                            [[ _round(item.latitude) ]]&deg;, [[ _round(item.longitude) ]]&deg;
                    </div>
                    <div class="control">
                        <div class="left">
                            <button on-click="_clickShowGeoTag" title="Show the location of this waypoint in the map">&#128065;</button>
                            <button on-click="_clickApplyGeoTag" title="Assign the current location from the map to this waypoint">&#128205;</button>
                            <button on-click="_clickUpdateTimezone" title="Lookup the timezone offset for this location">&#128336;</button>
                            <button on-click="_clickEditWaypoint" title="Edit the waypoint" disabled>&#128393;</button>
                        </div>
                        <div class="right">
                            <button on-click="_clickInsertWaypoint" title="Insert a new waypoint with the current location from the map after this waypoint">&#10133;</button>
                            <button class="clear" on-click="_clickRemoveWaypoint" title="Remove this waypoint from the list">&#10134;</button>
                        </div>
                    </div>
                </div>
                <!--
                <div class="insertor">
                    <button on-click="_clickInsertWaypoint" title="Insert a new waypoint">&#10133;</button>
                </div>
                -->
            </template>
        </div>
    </template>

    <script>
        // import photo reference class from electron
        var GeoFile = require( 'electron' ).remote.require( './geofile.js' );
        var Waypoint = require( 'electron' ).remote.require( './waypoint.js' );

        /** @polymerElement */
        class GeoTagGpx extends Polymer.Element {

            /**
             *
             */
            static get is() {
                return 'geotag-gpx';
            }

            /**
             *
             */
            static get properties() {
                return {
                    latitude: {
                        type: Number,
                        value: Number.NaN,
                        notify: true, // enable upward data flow,
                        //readOnly: true, // prevent downward data flow
                    },
                    longitude: {
                        type: Number,
                        value: Number.NaN,
                        notify: true, // enable upward data flow,
                        //readOnly: true, // prevent downward data flow
                    }
                };
            }

            /**
             *
             */
            ready() {
                super.ready();
                this.geo = new GeoFile();
                this.notifyPath( 'geo.waypoints' );
            }

            /**
             *
             */
            _round( value ) {
                try {
                    return value.toFixed( 5 );
                } catch( e ) {
                    return Number.NaN;
                }
            }

            /**
             *
             */
            _date( dateTime, timezone ) {
                try {
                    let options = {
                        weekday: 'short',
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: 'numeric',
                        second: 'numeric',
                        timeZone: ( timezone ? timezone : 'UTC' ),
                        timeZoneName: 'short'
                    };
                    return dateTime.toLocaleString( undefined, options );
                } catch( e ) {
                    return 'UNKNOWN DATE & TIME';
                }
            }

            /**
             *
             */
            _tooltip( waypoint ) {
                let tooltip = [];
                tooltip.push( 'Title: ' + waypoint.title );
                tooltip.push( 'Description: ' + waypoint.description );
                tooltip.push( 'Time (ISO): ' + ( waypoint.time ? waypoint.toISOString() : 'UNKNOWN DATE & TIME' ) );
                tooltip.push( `Coordinates: ${ this._round(waypoint.latitude) }°, ${ this._round(waypoint.longitude) }°`);
                tooltip.push( 'Altitude: ' + waypoint.altitude);
                tooltip.push( 'Link: ' + waypoint.link );
                return tooltip.join( '\n' );
            }

            /**
             *
             */
            _classForWaypoint( waypoint ) {
                try {
                    if( !waypoint.link ) {
                        throw new Error( 'No link!' );
                    }
                    if( waypoint.length < 1 ) {
                        throw new Error( 'Invalid link!' );
                    }
                    return 'photo';
                } catch( e ) {
                    return '';
                }
            }

            /**
             *
             */
            _changedGeoFile( event ) {
                try {
                    this.geo.importGEO( 'test.gpx' );
                    this.notifyPath( 'geo.waypoints' );
                    console.log( 'TODO: clear file input ...' );
                } catch( e ) {
                    throw e;
                }
            }

            /**
             *
             */
            _clickClear( event ) {
                try {
                    this.set( 'geo.waypoints', [] );
                    console.log( 'TODO: clear file input ...' );
                } catch( e ) {
                    throw e;
                }
            }

            /**
             *
             */
            _clickExport( event ) {
                try {
                    console.log( event );
                } catch( e ) {
                    throw e;
                }
            }

            /**
             *
             */
            _clickShowGeoTag( event ) {
                let waypoint = event.model.item;
                this.latitude = waypoint.latitude;
                this.longitude = waypoint.longitude;
            }

            /**
             *
             */
            _clickApplyGeoTag( event ) {
                let index = event.model.index;
                this.set( `geo.waypoints.${index}.latitude`, this.latitude );
                this.set( `geo.waypoints.${index}.longitude`, this.longitude );
            }

            /**
             *
             */
            _clickUpdateTimezone( event ) {
                try {
                    let index = event.model.index;
                    let waypoint = event.model.item;
                    this._getTimezoneForLocation( waypoint.latitude, waypoint.longitude, waypoint.time )
                    .then( ( timezone ) => {
                        this.set( `geo.waypoints.${index}.timezone`, timezone.timeZoneId );
                    } )
                    .catch( ( e ) => {
                        throw e;
                    } );
                } catch( e ) {
                    throw e;
                }
            }

            /**
             *
             */
            _clickRemoveWaypoint( event ) {
                try {
                    let index = event.model.index;
                    let waypoint = event.model.item;
                    let waypoints = this.geo.waypoints;
                    waypoints.splice( index, 1 );
                    this.set( 'geo.waypoints', waypoints );
                    // simple versions do not work for some reason ...
                    //this.splice( 'geo.waypoints', index );
                    // or
                    //this.geo.waypoints.splice( index );
                    //this.notifyPath( 'geo.waypoints' );
                } catch( e ) {
                    throw e;
                }
            }

            /**
             *
             */
            _clickInsertWaypoint( event ) {
                try {
                    let index = ( event.model ? event.model.index : -1 );
                    let waypoints = this.geo.waypoints;
                    waypoints.splice( index + 1, 0, new Waypoint( this.longitude, this.latitude ) );
                    this.set( 'geo.waypoints', waypoints );
                } catch( e ) {
                    throw e;
                }
            }

            /**
             * 
             */
            photoEventHandler( event ) {
                try {
                    let photo = event.detail;
                    let dateTime = photo.dateOriginal + ' ' + photo.timeOriginal;
                    this._getTimezoneForLocation( photo.latitude, photo.longitude, new Date( dateTime ) )
                    .then( ( timezone ) => {
                        let offset = this._getTimezoneOffset( timezone );
                        let link = photo.uri.split( '/' );
                        link = link[link.length - 1];
                        dateTime = new Date( dateTime + ' ' + offset );
                        this._addWaypoint( '', '', dateTime, timezone, photo.latitude, photo.longitude, 0.0, link );
                    } )
                    .catch( ( e ) => {
                        throw e;
                    } );
                } catch( e ) {
                    throw e;
                }
            }

            /**
             * 
             */
            _addWaypoint( title, description, time, timezone, latitude, longitude, altitude, link ) {
                try {
                    let waypoints = this.geo.waypoints;
                    let index = waypoints.findIndex( w => w.link === link );
                    if( index < 0 || confirm( `A waypoint for '${link}' already exist.\n\nReplace the existing waypoint?` ) ) {
                        let waypoint = new Waypoint( latitude, longitude );
                        waypoint.title = title;
                        waypoint.description = description;
                        waypoint.time = time;
                        waypoint.timezone = timezone.timeZoneId;
                        waypoint.altitude = altitude;
                        waypoint.link = link;
                        waypoints.push( waypoint );
                        if( index > -1 ) {
                            waypoints.splice( index, 1 );
                        }
                        this.set( 'geo.waypoints', waypoints );
                    }
                } catch( e ) {
                    throw e;
                }
            }

            /**
             * Determine the timezone for the given local date and time at the given coordinates.
             * Returns a promise.
             */
            _getTimezoneForLocation( latitude, longitude, dateTime ) {
                try {
                    let key = 'AIzaSyAI65pf3plY-90Ja59xMLFyPrIewKJ93eM';
                    let ts = Math.floor( dateTime.getTime() / 1000 );
                    let uri = `https://maps.googleapis.com/maps/api/timezone/json?location=${latitude},${longitude}&timestamp=${ts}&key=${key}`;
                    return fetch( uri )
                    .then( ( response ) => {
                        if( !response.headers.get( 'Content-Type' ).startsWith( 'application/json' ) ) {
                            throw new Error( 'Response is not in JSON format!' );
                        }
                        if( response.status !== 200 ) {
                            throw new Error( 'Status code: ' + response.status );
                        }
                        return response.json();
                    } )
                    .then( ( json ) => {
                        if( json.status !== 'OK' ) {
                            throw new Error( json.status );
                        }
                        return json;
                    } );
                } catch( e ) {
                    return new Promise( ( resolve, reject ) => {
                        reject( e );
                    } );
                }
            }

            /**
             * Get the signed 4 digit UTC offset for the given timezone (±HHMM)
             */
            _getTimezoneOffset( timezone ) {
                try {
                    let offset = timezone.rawOffset + timezone.dstOffset;
                    let sign = ( offset > 0 ? '+' : '-' );
                    let hours = Math.floor( offset / 3600 );
                    let minutes = Math.floor( ( offset - ( 3600 * hours ) ) / 60 );
                    hours = ( '0' + hours ).slice( -2 );
                    minutes = ( '0' + minutes ).slice( -2 );
                    return sign + hours + minutes;
                } catch ( e ) {
                    throw e;
                }
            }
        }
        window.customElements.define(GeoTagGpx.is, GeoTagGpx);
    </script>

</dom-module>