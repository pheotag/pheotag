<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">

<dom-module id="geotag-gpx">

    <template>
        <style>
            :host {
                display: flex;
                flex-direction: column;
                width: 100%;
                height: 100%;
                font-size: 10pt;
                font-family: Roboto;
            }
            button {
                cursor: pointer;
            }
            .file {
                flex: initial;
                overflow-x: hidden;
                word-wrap: none;
                white-space: nowrap;
                padding: 0.25em;
                border-bottom: 1px solid lightgrey;
            }
            #file {
                outline: none; /* disable chromium highlighting of input fields */
                -webkit-appearance: none;
                   -moz-appearance: none;
                        appearance: none;
            }
            .clear {
                color: red;
            }
            .export {
                color: royalblue;
            }
            #filter {
                flex: initial;
                margin: 0.25em;
                width: calc(100% - 0.75em);
                outline: none; /* disable chromium highlighting of input fields */
            }
            #container {
                flex: 1;
                overflow-y: scroll;
            }
            .waypoint {
                margin: 10px;
                box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5);
            }
            .photo {
                color: whitesmoke;
                border: 1px solid black;
                background-color: black;
            }
            .time {
                padding: 0.15em;
                text-align: center;
            }
            .latlong {
                padding: 0.15em;
                text-align: center;
                font-family: monospace;
            }
            .control {
                flex: initial;
                display: table;
                width: calc(100% - 2*0.15em);
                padding: 0.15em;
            }
            .control > .left {
                display: table-cell;
                text-align: left;
            }
            .control > .right {
                display: table-cell;
                text-align: right;
            }
        </style>
        <div class="file">
                <input id="file" type="file" on-change="_changedGeoFile" accept=".gpx,.kml" />
            <button class="clear" on-click="_clickClear" title="Clear the list of waypoints">&#10008;</button>
            <button class="export" on-click="_clickExport" title="Export the list of waypoints">&#129095;</button>
        </div>
        <input id="filter" type="text" value="{{ filter::input }}"/>
        <div id="container">
            <template is="dom-repeat" items="[[ geo.waypoints ]]">
                <div class$="waypoint [[ _classForWaypoint(item) ]]" title$="[[ _tooltip(item) ]]">
                    <div class="time">[[ item.time ]]</div>
                    <div class="latlong">
                            [[ _round(item.latitude) ]]&deg;, [[ _round(item.longitude) ]]&deg;
                    </div>
                    <div class="control">
                        <div class="left">
                            <button on-click="_clickShowGeoTag" title="Show the location of this waypoint in the map">&#128065;</button>
                            <button on-click="_clickApplyGeoTag" title="Assign the current location from the map to this waypoint">&#128205;</button>
                            <button on-click="_clickEditDateTime" title="Edit the date and time">&#128336;</button>
                            <button on-click="_clickEditWaypoint" title="Edit the waypoint">&#128393;</button>
                        </div>
                        <div class="right">
                            <button class="clear" on-click="_clickRemoveWaypoint" title="Remove this waypoint from the list">&#10134;</button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </template>

    <script>
        // import photo reference class from electron
        var GeoFile = require( 'electron' ).remote.require( './geofile.js' );

        /** @polymerElement */
        class GeoTagGpx extends Polymer.Element {

            /**
             *
             */
            static get is() {
                return 'geotag-gpx';
            }

            /**
             *
             */
            static get properties() {
                return {
                    latitude: {
                        type: Number,
                        value: Number.NaN,
                        notify: true, // enable upward data flow,
                        //readOnly: true, // prevent downward data flow
                    },
                    longitude: {
                        type: Number,
                        value: Number.NaN,
                        notify: true, // enable upward data flow,
                        //readOnly: true, // prevent downward data flow
                    }
                };
            }

            /**
             *
             */
            ready() {
                super.ready();
                this.geo = new GeoFile();
                this.notifyPath( 'geo.waypoints' );
            }

            /**
             *
             */
            _round( value ) {
                try {
                    return value.toFixed( 5 );
                } catch( e ) {
                    console.warn( e );
                    return Number.NaN;
                }
            }

            /**
             *
             */
            _date( timestamp ) {
                try {
                    let options = {
                        weekday: 'short',
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: 'numeric',
                        second: 'numeric',
                        timeone: null
                    };
                    return dateTime.toLocaleDateString( undefined, options );
                } catch( e ) {
                    console.warn( e );
                    return 'UNKNOWN DATE';
                }
            }

            /**
             *
             */
            _tooltip( waypoint ) {
                let tooltip = [];
                tooltip.push( 'Title: ' + waypoint.title );
                tooltip.push( 'Description: ' + waypoint.description );
                tooltip.push( 'Time: ' + waypoint.time );
                tooltip.push( `Coordinates: ${ this._round(waypoint.latitude) }°, ${ this._round(waypoint.longitude) }°`);
                tooltip.push( 'Altitude: ' + waypoint.altitude);
                tooltip.push( 'Link: ' + waypoint.link );
                return tooltip.join( '\n' );
            }

            /**
             *
             */
            _classForWaypoint( waypoint ) {
                try {
                    if( !waypoint.link ) {
                        throw new Error( 'No link!' );
                    }
                    if( waypoint.length < 1 ) {
                        throw new Error( 'Invalid link!' );
                    }
                    return 'photo';
                } catch( e ) {
                    return '';
                }
            }

            /**
             *
             */
            _changedGeoFile( event ) {
                try {
                    console.log( event );
                    this.geo.importGEO( 'test.gpx' );
                    this.notifyPath( 'geo.waypoints' );
                    console.log( 'TODO: clear file input ...' );
                } catch( e ) {
                    //console.warn( e );
                }
            }

            /**
             *
             */
            _clickClear( event ) {
                try {
                    this.set( 'geo.waypoints', [] );
                    console.log( 'TODO: clear file input ...' );
                } catch( e ) {
                    console.warn( e );
                }
            }

            /**
             *
             */
            _clickExport( event ) {
                try {
                    console.log( event );
                } catch( e ) {
                    console.warn( e );
                }
            }

            /**
             *
             */
            _clickShowGeoTag( event ) {
                let waypoint = event.model.item;
                this.latitude = waypoint.latitude;
                this.longitude = waypoint.longitude;
            }

            /**
             *
             */
            _clickApplyGeoTag( event ) {
                let index = this.geo.waypoints.indexOf( event.model.item );
                this.set( `geo.waypoints.${index}.latitude`, this.latitude );
                this.set( `geo.waypoints.${index}.longitude`, this.longitude );
            }

            /**
             * 
             */
            photoEventHandler( event ) {
                try {
                    let photo = event.detail;
                    this._timezoneOffset( photo.latitude, photo.longitude, photo.dateOriginal, photo.timeOriginal )
                    .then( ( offset ) => {
                        let link = photo.uri.split( '/' );
                        link = link[link.length - 1];
                        let dateTime = new Date( `${photo.dateOriginal} ${photo.timeOriginal} ${offset}` );
                        console.log( dateTime.toISOString() );
                        this._addWaypoint( '', '', dateTime, photo.latitude, photo.longitude, 0.0, link );
                    } )
                    .catch( ( e ) => {
                        console.error( e );
                    } );
                } catch( e ) {
                    console.error( e );
                }
            }

            /**
             * 
             */
            _addWaypoint( title, description, time, latitude, longitude, altitude, link ) {
                try {
                    let waypoints = this.geo.waypoints;
                    let index = waypoints.findIndex( w => w.link === link );
                    if( index < 0 || confirm( `A waypoint for '${link}' already exist.\n\nReplace the existing waypoint?` ) ) {
                        let waypoint = {
                            title: title,
                            description: description,
                            time: time,
                            latitude: latitude,
                            longitude: longitude,
                            altitude: altitude,
                            link: link
                        };
                        waypoints.push( waypoint );
                        if( index > -1 ) {
                            waypoints.splice( index, 1 );
                        }
                        this.set( 'geo.waypoints', waypoints );
                    }
                } catch( e ) {
                    console.warn( e );
                }
            }

            /**
             *
             */
            _clickRemoveWaypoint( event ) {
                try {
                    let waypoint = event.model.item;
                    let waypoints = this.geo.waypoints;
                    let index = waypoints.findIndex( w => w === waypoint );
                    if( index > -1 ) {
                        waypoints.splice( index, 1 );
                        this.set( 'geo.waypoints', waypoints );
                    }
                } catch( e ) {
                    throw e;
                }
            }

            /**
             * Determine the timezone offset for the given local date and time
             * regarding the given coordinates.
             */
            _timezoneOffset( lat, long, date, time ) {
                let key = 'AIzaSyAI65pf3plY-90Ja59xMLFyPrIewKJ93eM';
                let ts = Math.floor( ( new Date( date + ' ' + time ) ).getTime() / 1000 );
                let uri = `https://maps.googleapis.com/maps/api/timezone/json?location=${lat},${long}&timestamp=${ts}&key=${key}`;
                return new Promise( ( resolve, reject ) => {
                    fetch( uri )
                    .then( ( response ) => {
                        try {
                            if( !response.headers.get( 'Content-Type' ).startsWith( 'application/json' ) ) {
                                throw new Error( 'Response is not in JSON format!' );
                            }
                            if( response.status !== 200 ) {
                                throw new Error( 'Status code: ' + response.status );
                            }
                            response.json()
                            .then( ( content ) => {
                                try {
                                    if( content.status !== 'OK' ) {
                                        throw new Error( content.status );
                                    }
                                    resolve( this._timezoneOffsetString( content.rawOffset, content.dstOffset ) );
                                } catch( e ) {
                                    reject( e );
                                }
                            } )
                            .catch( ( e ) => {
                                reject( e );
                            } );
                        } catch( e ) {
                            reject( e );
                        }
                    } )
                    .catch( ( e ) => {
                        reject( e );
                    } );
                } );
            }

            /**
             * 
             */
            _timezoneOffsetString( offsetRAW, offsetDST ) {
                try {
                    let offset = offsetRAW + offsetDST;
                    let hours = Math.floor( offset / 3600 );
                    let minutes = Math.floor( ( offset - ( 3600 * hours ) / 60 ) );
                    return '+0900';
                } catch ( e ) {
                    throw e;
                }
            }
        }
        window.customElements.define(GeoTagGpx.is, GeoTagGpx);
    </script>

</dom-module>